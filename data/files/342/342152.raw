#to do:
#(2) better interface for when we want derivatives w/r/t some args of multiarg fns
using RAD, Base.Test, Debug
reload("RAD.jl")


#test storing and unstoring intermediate values
tape1 = Float64[]
tape2 = {}
y=1.5
storeIntermediate!(tape1,tape2,y)
z = unstoreIntermediate!(tape1,tape2,typeof(y))
@assert z==y

#
@autodiff (theta,) function myloop2(theta)
	y=1.0
	for tt=1:3
		y = y*theta
	end
	y
end
@test_approx_eq myloop2(Seed(1.0),WRT(2.0))[1] 2.0^3
@test_approx_eq myloop2(Seed(1.0),WRT(2.0))[2] 3*2.0^2 #fails!
#we don't currently flag y as overwriting!  -- need to make this happen inside
#for loop
#compiles, but is wrong.  


@autodiff (theta,) function myloop1(theta)
	y=0.0
	for tt=1:10
		if mod(tt,2)==0
			y += theta
		end
	end
	y
end
@test myloop1(Seed(1.0),WRT(1.1)) == (5.5,5.0)

@autodiff (theta,) function f1(theta,x)
	dot(theta,x)
end
theta = rand(3); x=rand(3);
@test f1(Seed(1.0),WRT(theta),x) == (dot(theta,x),x)


@autodiff (theta,) function f2(theta)
	if(theta>1)
		theta + 1.0
	else
		2.0
	end
end
@test f2(Seed(1.0),WRT(1.1)) === (2.1,1.0)
@test f2(Seed(1.0),WRT(0.9)) === (2.0,0.0)


@autodiff (theta,x) function mysum(theta,x)
	theta + x
end
@test mysum(Seed(1.0),WRT(1.5),2.0) === (3.5,1.0)
@test mysum(Seed(1.0),WRT(1.5),WRT(2.0)) === (3.5,1.0,1.0)
