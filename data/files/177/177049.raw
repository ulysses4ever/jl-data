#predict.jl
#This script takes spectrograms and computes the corresponding predictions
#author: Timothy Evans
#date: 30/07/15

push!(LOAD_PATH, pwd())
importall signalprocessing, config
using Images, DataFrames, DecisionTree, JLD, BoundingBoxes

#load paths from config.jl
(specpath,labelledpath,trainpath,modelpath) = loadpaths();

#add in extract spectrograms here

#load in Random Forest classifier
model = jldopen(string(modelpath,"model.jld"),"r") do file
  read(file,"model")
end

#normalise features using saved mean and standard dev
normvalues = readcsv(string(modelpath,"musigma.csv"));
mu = normvalues[1,:];
sigma = normvalues[2,:];

for spec in readdir(specpath)

  print("loading image $spec\n");
  img = imread(string(trainpath,spec));
  recorderdata = readtable(string(modelpath,"recorderdata.csv"));
  (pixels,freq,boxmu,boxvar) = imgfeature_predict(img,spec,recorderdata);
  featuredata = hcat(pixels,freq,boxmu,boxvar);
  (m,n) = size(featuredata);
  X = (featuredata - ones(m)*mu) ./ (ones(m)*sigma);
  y = apply_forest(model,X);
  predimg = reshapepred(y,width(img),height(img)));
  (nsyllables) = segmentimg(predimg);
end
