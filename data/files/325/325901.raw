using TensorBase
using Base.Test

## Matrix Unfoldings ##

# example tensor
A = reshape(1:24,2,3,4)

# mode-1 unfolding
A1 = [ 1  3  5  7   9  11  13  15  17  19  21  23
       2  4  6  8  10  12  14  16  18  20  22  24 ]

# mode-2 unfolding
A2 = [ 1  2   7   8  13  14  19  20
       3  4   9  10  15  16  21  22
       5  6  11  12  17  18  23  24 ]

# mode-3 unfolding
A3 = [ 1   2   3   4   5   6
       7   8   9   10  11  12
       13  14  15  16  17  18
       19  20  21  22  23  24 ]

@test all(unfold(A,1) .== A1)
@test all(unfold(A,2) .== A2)
@test all(unfold(A,3) .== A3)


## Khatri-Rao Product ##

A = [1 3; 2 4]
B = ones(5,2)
C = krprod(A,B)

@test size(C) == (10,2)
@test all(C[1:5,1]  .== 1)
@test all(C[6:10,1] .== 2)
@test all(C[1:5,2]  .== 3)
@test all(C[6:10,2] .== 4)


## Mode-N Product ##

A = randn(3,3)
B = randn(3)
@test all(isapprox(tensordot(A,B,1),vec(B'*A)))
@test all(isapprox(tensordot(A,B,2),vec(A*B)))

A = randn(3,3)
B = randn(2,3)
@test all(isapprox(tensordot(A,B,1),B*A))
@test all(isapprox(tensordot(A,B,2),A*B'))

## CP-decomp toy problem ##

A,factors = gen_cpd([5,6,7],3,0.0)
X,Y,Z = factors
@einsum A2[i,j,k] := X[i,r]*Y[j,r]*Z[k,r]
@test all(isapprox(A,A2))
