## -------------------------------------------------------
## Utilities to handle radar products of Meteo Swiss
##
## Andreas Scheidegger -- andreas.scheidegger@eawag.ch
## -------------------------------------------------------

module MeteoSchweizRadarTools

using Images

export read_radar

## ---------------------------------
## convert a radar gif into array with rain intensities

function read_radar(image::Image, x1, y1, x2, y2)
    ## x1:  coordinate of *bottom left* point of pixel in CH1903
    ## y1:  coordinate of *bottom left* point of pixel in CH1903
    ## x2:  coordinate of *top right* point of pixel in CH1903
    ## y2:  coordinate of *top right* point of pixel in CH1903

    @assert mod(x1, 1000) == 0
    @assert mod(x2, 1000) == 0
    @assert mod(y1, 1000) == 0
    @assert mod(y2, 1000) == 0

    @assert 255000 <= x1 < x2 <= 965000
    @assert -160000 <= y1 < y2 <= 480000

    if size(image) == (786, 716)
        xrange = (x1/1000 - 255 + 1) : (x2/1000 - 255)
        yrange = (480 + 76 + 1 - y2/1000) : (480 + 76 - y1/1000)
    elseif size(image) == (710, 640)
        xrange = (x1/1000 - 255 + 1) : (x2/1000 - 255)
        yrange = (480 + 1 - y2/1000) : (480 - y1/1000)
    else
        error("Only TZC or RZC products can be read.")
    end

    arr_col = float64(reinterpret(Uint8, data(image[xrange, yrange])))

    return convert2rain(arr_col)
end


function read_radar(imagepath::String, x1, y1, x2, y2)
    img = imread(imagepath)
    read_radar(img, x1, y1, x2, y2)
end



function convert2rain(arr_col)
    arr_rain = Array(Float64, size(arr_col, 2), size(arr_col, 3))
    for x in 1:size(arr_col,2)
        for y in 1:size(arr_col,3)
               arr_rain[x,y] = codeDict[arr_col[:,x,y]]
        end
    end

    arr_rain
end



## code from file "8bit_Metranet_v102.txt"
## and convert to Dict

const code =
    [ 255     255     255      -10.0  # echo suppressed
     235     235     235     0.0001
     145     161     161      0.10
     143     159     163      0.15
     141     157     165      0.20
     140     156     167      0.25
     138     154     168      0.30
     136     152     170      0.35
     134     150     172      0.40
     133     149     174      0.45
     131     147     175      0.50
     129     145     177      0.55
     127     143     179      0.60
     126     142     181      0.65
     124     140     182      0.70
     122     138     184      0.75
     120     136     186      0.80
     119     135     187      0.85
     119     134     188      0.90
     117     132     190      0.95
     115     130     192      1.00
     113     127     195      1.1
     111     125     197      1.25
     109     122     199      1.35
     107     120     202      1.45
     105     117     204      1.55
     104     115     207      1.65
     102     113     209      1.75
     100     110     211      1.85
     98      108     214      1.95
     96      105     216      2.00
     94      103     218      3.05
     92      100     221      4.05
     90      98      223      5.05
     89      96      225      6.05
     89      96      226      7.05
     85      95      227      8.05
     82      95      229      9.05
     79      95      231      10.05
     76      94      233      11.05
     73      94      235      12.05
     70      94      236      13.05
     67      93      238      14.05
     64      93      240      15.05
     61      93      242      16.05
     58      92      244      17.05
     55      92      245      18.05
     52      92      247      19.05
     49      91      249      20.05
     46      91      251      21.05
     43      91      253      22.05
     40      91      254      23.05
     40      94      255      24.05
     40      95      253      25.05
     40      100     252      26.05
     40      104     250      27.05
     40      109     249      28.05
     40      114     247      29.05
     40      118     246      30.05
     40      123     244      31.05
     40      128     243      32.05
     40      132     242      33.05
     40      137     240      34.05
     40      141     239      35.05
     40      146     237      36.05
     40      151     236      37.05
     40      155     234      38.05
     40      160     233      39.05
     40      163     232      40.05
     40      165     231      41.05
     40      166     230      42.05
     41      168     228      43.05
     42      169     226      44.05
     43      171     225      45.05
     44      173     223      46.05
     44      174     221      47.05
     45      176     219      48.05
     46      178     218      49.05
     47      179     216      50.05
     48      181     214      51.05
     48      182     212      52.05
     49      184     211      53.05
     50      186     209      54.05
     51      187     207      55.05
     52      189     205      56.05
     53      190     204      57.05
     53      191     203      58.05
     54      192     202      59.05
     55      193     201      60.05
     57      195     200      61.05
     58      196     198      62.05
     60      198     197      63.05
     61      199     196      64.05
     63      201     194      65.05
     64      202     193      66.05
     65      203     192      67.05
     67      205     190      68.05
     68      206     189      69.05
     70      208     188      70.05
     71      209     186      71.05
     73      211     185      72.05
     74      212     184      73.05
     76      213     183      74.05
     76      214     182      75.05
     77      215     181      76.05
     78      216     179      77.05
     80      217     178      78.05
     81      219     176      79.05
     83      220     175      80.05
     84      221     173      81.05
     86      222     172      82.05
     87      224     170      83.05
     88      225     168      84.05
     90      226     167      85.05
     91      227     165      86.05
     93      229     164      87.05
     94      230     162      88.05
     96      231     161      89.05
     97      232     159      90.05
     99      233     158      91.05
     99      234     157      92.05
     102     234     156      93.05
     105     235     154      94.05
     109     235     153      95.05
     112     236     151      96.05
     115     237     149      97.05
     119     237     148      98.05
     122     238     146      99.05
     126     239     145      100.05
     129     239     143      101.05
     132     240     141      102.05
     136     240     140      103.05
     139     241     138      104.05
     142     242     136      105.05
     146     242     135      106.05
     149     243     133      107.05
     151     244     132      108.05
     153     244     131      109.05
     155     244     129      110.05
     157     245     127      111.05
     159     246     125      112.05
     161     246     123      113.05
     163     247     121      114.05
     166     248     119      115.05
     168     248     117      116.05
     170     249     115      117.05
     172     250     113      118.05
     174     250     111      119.05
     177     251     109      120.05
     179     252     107      121.05
     181     252     105      122.05
     183     253     103      123.05
     185     254     101      124.05
     186     255     99       125.05
     188     255     98       126.05
     190     255     97       127.05
     192     255     95       128.05
     195     255     94       129.05
     197     255     92       130.05
     199     255     90       131.05
     202     255     89       132.05
     204     255     87       133.05
     207     255     86       134.05
     209     255     84       135.05
     211     255     82       136.05
     214     255     81       137.05
     216     255     79       138.05
     218     255     77       139.05
     221     255     76       141.05
     223     255     74       142.05
     224     255     73       143.05
     226     255     71       144.05
     226     253     69       145.05
     227     251     65       146.05
     227     249     62       147.05
     228     247     58       148.05
     229     245     55       149.05
     229     243     51       150.05
     230     241     48       151.05
     231     240     44       152.05
     231     238     40       153.05
     232     236     37       154.05
     232     234     33       155.05
     233     232     30       156.05
     234     230     26       157.05
     234     228     23       158.05
     235     226     19       159.05
     236     225     17       160.05
     236     224     16       161.05
     237     223     15       162.05
     238     221     14       163.05
     239     219     13       164.05
     240     217     12       165.05
     241     215     11       166.05
     243     214     10       167.05
     244     212     9        168.05
     245     210     9        169.05
     246     208     8        170.05
     247     206     7        171.05
     249     205     6        172.05
     250     203     5        173.05
     251     201     4        174.05
     252     199     3        175.05
     253     197     2        176.05
     254     196     2        177.05
     255     196     3        178.05
     255     192     5        179.05
     255     189     8        180.05
     255     186     11      181.05
     255     183     14      182.05
     255     180     17      183.05
     255     176     20      184.05
     255     173     23      185.05
     255     170     26      186.05
     255     167     29      187.05
     255     164     32      188.05
     255     160     35      189.05
     255     157     38      190.05
     255     154     41      191.05
     255     151     44      192.05
     255     148     47      193.05
     255     147     48      194.05
     255     145     50      195.05
     254     140     49      196.05
     253     136     48      197.05
     252     132     47      198.05
     252     127     47      199.05
     251     123     46      200.05
     250     119     45      201.05
     250     114     44      202.05
     249     110     44      203.05
     248     106     43      204.05
     248     101     42      205.05
     247     97      41      206.05
     246     93      41      207.05
     246     88      40      208.05
     245     84      39      209.05
     244     80      38      210.05
     244     78      38      220.05
     244     76      38      230.05
     244     73      39      240.05
     245     70      40      250.05
     246     67      41      260.05
     246     65      42      270.05
     247     62      43      280.05
     248     59      44      290.05
     248     57      45      300.05
     249     54      47      310.05
     250     51      48      320.05
     250     49      49      330.05
     251     46      50      340.05
     255     0       0       -99     # reserved
     0       255     0       -99     # reserved
     0       0       255     -99     # reserved
     255     255     255     -99     # reserved (not used)
     0       0       0       -100 ]  # no echo / pixel not covered by any radar

codeDict = Dict{Array{Float64,1}, Float64}()

for k in 1:size(code, 1)
    codeDict[vec(code[k,1:3])] = code[k, 4]
end


end # module
