using HTTPClient.HTTPC
using ZipFile


function generateFileName(dateValue)
	today = TmStruct(dateValue)
	if ( today.wday > 0 && today.wday < 6 )
		return string ("EQ", lpad(today.mday,2,0) , lpad(today.month+1,2,0) , lpad(today.year%100,2,0), "_CSV.ZIP")
	else
		return string ("")
	end
end

function downloadBhavFile(filename::String)
	ostream=open("/tmp/$(filename)", "w+")
	r=HTTPClient.get("http://www.bseindia.com/download/BhavCopy/Equity/$(filename)", RequestOptions(ostream=ostream))
	r.http_code == 200
	close(ostream)
end

function extractZip(filename::String)
	r = ZipFile.Reader("/tmp/$(filename)");
	for f in r.files
		ostream = open("/tmp/$(f.name)","w+")
		write (ostream,readall(f))
		close (ostream)
	end
	close(r)
end

function downloadAndExtract (filename::String)
	if ( filename != "" )
		downloadBhavFile(filename)
		extractZip(filename)
	end
end

function getHistoricalData(numOfDays)
	for i = 0:numOfDays
		downloadAndExtract(generateFileName(time()-60*60*24*i))
	end
end
