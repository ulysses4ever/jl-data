using Base.Test
using JLab
import PyPlot.plt

#Sample signal
t = linspace(0,10,200)
x = t+0.5*sin(t)
#y = sin(t) + 0.1*randn(200)
y = [0.04889801151338137,0.14167698451074615,0.18852842254838376,-0.06730610848407664,0.32302325852394564,0.0960313769284484,0.48174873110261607,0.21099790040925218,0.3552565631443496,0.4939076555368545,0.5212527493652478,0.40758534116775536,0.6572114035032313,0.7543894016594807,0.7671692365990186,0.6624272799733736,0.6376377656561304,0.793968189458669,0.9155017881173709,0.89154661067303,0.7499812614309679,0.9220715910982067,0.8930357705780115,0.7929971182321489,1.128989442554497,0.883779921964377,0.9448567643285691,0.9867684667335193,1.1112835654189306,1.029683534217917,0.8628302682251732,1.0469785955164062,0.9082819063439345,1.0342624268241076,1.1795430778169462,1.1226264226926916,0.9617064148991052,0.8079994652833593,0.9938021659671107,1.029375449659298,0.9567395519763752,0.9845701442405435,0.9606761711632602,0.7332433207686523,0.779210038854365,0.7520514795021999,0.8029186144246572,0.7964403544013389,0.6054486182647735,0.7501904906720759,0.5455487314756352,0.5831779812207903,0.4581915554025408,0.3450608038286947,0.44993410716090304,0.3788198177110955,0.36814021886370224,0.1722441565438813,0.3394403337155309,0.31810516942141376,0.19357807132301413,0.28079694753016043,0.14481090176075223,-0.05358740432501939,-0.08425251544530304,-0.186128354024506,-0.19644369825477867,-0.1794215888241722,-0.2538519872611996,-0.4249214535399859,-0.3581262695219332,-0.4060226645999273,-0.34878651274810646,-0.5624141727410857,-0.21109809122041368,-0.611439195801712,-0.514613401792811,-0.6449687370959183,-0.8992830929207721,-0.8103666417955404,-0.7107315372010081,-0.7839331703611574,-0.7686734968348049,-0.8797439213845057,-0.8803049508902966,-0.9023665237027285,-0.9230519986495501,-0.9317619659953854,-0.8000851413263684,-0.869561046006806,-0.9932470294084677,-0.9262384055248982,-0.8466841117642137,-1.0950894796755417,-1.0040499086853172,-0.9983880861763975,-1.0416331039567865,-0.8342900755718934,-0.8198921396892274,-1.056216136411382,-0.988851599192967,-0.8923062500546111,-0.9365857719652642,-0.9337309271459682,-0.7037062675726249,-0.8941329553554146,-0.8309551757028661,-0.8016217886853004,-0.9671870202127282,-0.7232033293005108,-0.6681995452619776,-0.6245108177496093,-0.7890568991970812,-0.5578170170264152,-0.5779644273859466,-0.5684382021338876,-0.5615298264138928,-0.43304428525471844,-0.4084314233208268,-0.4128643658448755,-0.10943990074066268,-0.364416364608944,-0.12675686903786176,-0.020308099573100716,-0.04760737201843008,-0.10511504225163622,0.19239721571090335,-0.09220968930347834,0.19361869388277586,0.2750331940452949,0.3065484377601487,0.5324892510550248,0.34770179641355525,0.3540843636824394,0.45880397233168824,0.5150247409025969,0.5496672276095868,0.5324231967729154,0.5912327684866889,0.5286519037324913,0.8156814632234556,0.7213842986455845,0.7948980328290876,1.1172395640012858,0.8192443314458716,0.9383779461413657,0.7369828211991388,0.8772541081453694,0.8295198951049366,0.6979369682355483,1.0933880539453469,1.0341293594374048,1.0093693670299242,0.7966194094290887,1.0707173574344084,0.9312212258127489,1.103040883746824,1.2834161958693455,1.0246763810892925,0.9888152003230439,0.9104453542512415,0.9930473758017649,0.8095036899495667,0.9174846394991236,0.7320878525212926,0.8446008218981362,0.8703042291861222,0.8160216257415548,0.9985707597814881,0.8966682801043852,0.87276710079591,0.849903883403673,0.6588593001104753,0.7343157003782763,0.6690900526898952,0.6486474970247922,0.6157156082820511,0.42405206435820453,0.2576545724317549,0.268610107343483,0.5246889231990549,0.2548961933393251,0.29471747032379353,0.1792048049917073,0.21552091308150456,0.27256740230475474,0.16469946980292982,-0.04954651202441504,0.14376501461893731,0.08511405576459512,0.013545087141411158,-0.4199873939408857,-0.2621258595310936,-0.23023811432551564,-0.14445663559190686,-0.3404091824926321,-0.22130326409814513,-0.4536161939239471,-0.32201254557116354,-0.5752313409139599]


# #############################################################################
#Test moving average filter
println("########## Testing \"movavgfilt\" ##########")

#Returns unchanged for N=1
println("Testing preservation of data when N=1 ...")
yns = movavgfilt(y,1)
@test_approx_eq(maximum(abs(yns-y)),0)

#Smoothing
println("Testing smoothing ...")
ys = movavgfilt(y,15)
@test sqrt(mean((ys-sin(t)).^2)) < 0.04

println("Function \"movavgfilt\" passed tests.")


# #############################################################################
#Test Savitzky Golay filter
println("########## Testing \"sgolayfilt\" ##########")

#Check errors for fitting window <= fitting polynomial degree, or
#differentiation order > fitting polynomial degree
println("Testing input checking ...")
@test_throws sgolayfilt(y,1)
@test_throws sgolayfilt(y,5,deg=5)
@test_throws sgolayfilt(y,5,diff=3)

#Returns unchanged for N=1, deg=0
println("Testing preservation of data with N=1,deg=0 ...")
yns = sgolayfilt(y,1,deg=0)
@test_approx_eq(maximum(abs(yns-y)),0)

#Smoothing without independent variable
println("Testing smoothing w/o independent variable ...")
ys = sgolayfilt(y,30)
dys = sgolayfilt(y,30,diff=1)
d2ys = sgolayfilt(y,30,diff=2)
@test sqrt(mean((ys-sin(t)).^2)) < 0.04
@test sqrt(mean((dys-t[2]*cos(t)).^2)) < 0.004
@test sqrt(mean((d2ys+t[2]^2*sin(t)).^2)) < 0.0007

#Plots
#  plt.plot(t,y,"b")
#  plt.plot(t,ys,"g")
#  plt.plot(t,sin(t),color=[0,0.5,0])
#  plt.plot(t,dys,"r")
#  plt.plot(t,t[2]*cos(t),color=[0.5,0,0])
#  plt.plot(t,d2ys,"c")
#  plt.plot(t,-t[2]^2*sin(t),color=[0,0.5,0.5])

#Smoothing with independent variable
println("Testing smoothing with independent variable ...")
ys = sgolayfilt(x,y,35,deg=2)
dys = sgolayfilt(x,y,35,deg=2,diff=1)
d2ys = sgolayfilt(x,y,35,deg=2,diff=2)
@test sqrt(mean(((ys-sin(t))[17:end-17]).^2)) < 0.04
@test sqrt(mean(((dys-cos(t)./(1+0.5*cos(t)))[17:end-17]).^2)) < 0.2
@test sqrt(mean(((d2ys+sin(t)./(1+0.5*cos(t)).^3)[17:end-17]).^2)) < 0.5

#Plots
#  plt.plot(x,y,"b")
#  plt.plot(x,ys,"g")
#  plt.plot(x,sin(t),color=[0,0.5,0])
#  plt.plot(x,dys,"r")
#  plt.plot(x,cos(t)./(1+0.5*cos(t)),color=[0.5,0,0])
#  plt.plot(x,d2ys,"c")
#  plt.plot(x,-sin(t)./(1+0.5*cos(t)).^3,color=[0,0.5,0.5])

println("Function \"sgolayfilt\" passed tests.")