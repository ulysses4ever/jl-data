###################################################
## Run simulation
###################################################

"""
Takes a Data object as an argument, and runs a simulation of dynamic matching where
the matching policy and other parameters are defined a Params element.
The length of the simulation is specified by the steps parameters

Returns a DataFrame object with the statistics of the simulation run.
"""
function run_dynamic(d::Data, steps::Int64, brain::Brain, p::Params;
        pool::InstanceGraph = InstanceGraph())
  if p.verbose >= 0
    println("Running with steps = $steps, batch = $(p.batchSize), techno = $(p.techno), priorities= $(p.priorities)")
  end
  
  srand(p.seed)
  l = Log(length(d.type_names), 1)
  time_tot = []
  time_lp = []
  time_jump = []
  for k in 1:steps
    time_tot_tic = time()
    arriving_node_id = rand(1:d.n)
    arrival!(pool, arriving_node_id, d, k, l)
    if k%p.batchSize == 0
      time_tic = time()
      w = generate_weights(brain, pool.nodes, p)
      matched_nodes, value, solve_time, time_model = match(pool.graph, w, techno = p.techno, solver = p.solver)
      matched_value = match_value(pool, matched_nodes)
      if length(matched_nodes) > 0
        remove_matched!(pool, matched_nodes, k, l)
      end
      if k >= steps/2 #Only learn in steady-state (after 50% of time steps)
        update_weights(brain, float(value), pool.nodes)
      end
    end
    departures!(pool, k, l)
    push!(time_jump, time_model)
    push!(time_lp, solve_time)
    push!(time_tot, time() - time_tot_tic)
    if k%(steps/20) == 0
      print_status(pool, k, p, time_tot, time_lp, time_jump)
    end
  end
  return l
end

function print_status(pool::InstanceGraph, k::Int64, p::Params, time_tot::Array{Any,1}, time_lp::Array{Any,1}, time_jump::Array{Any,1})
  if p.verbose >= 1
    println("It: $k,  \t total time: $(round(mean(time_tot),5)),  \t lp time: $(round(mean(time_lp),5)),  \tJuMP time: $(round(mean(time_jump),5)),  \t pool size: $(pool.n)")
  end
end

function match_value(pool::InstanceGraph, matched::Array{Float64})
  ret = find(matched .>= 1 - 1e-6)
  value = 0
  for i in ret
    value += pool.nodes[i].weight
  end
  return value
end
