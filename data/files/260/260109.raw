function scenario_risk_preprocess(job_file)
  inputs = Dict{ASCIIString, ScenarioRiskInput}()
  f = jldopen(job_file, "r")
  num_gmfs = read(f, "number_of_ground_motion_fields")
  hazard_model = f["hazard"]
  vulnerability_model = f["vulnerability"]
  exposure_model = f["exposure"]
  tax_vf_model = f["tax_vf_map"]

  assets = read_exposure(exposure_model)
  vulnerabilities = read_vulnerability(vulnerability_model)
  tax_vf_map = read_tax_vf(tax_vf_model)

  branches = names(hazard_model)
  for branch in branches
    gmf_params = read_gmf_params(hazard_model[branch])
    gmfs = sample_gmfs(gmf_params..., num_gmfs)
    inputs[branch] = ScenarioRiskInput(assets, gmfs, tax_vf_map)
  end

  close(f)
  return inputs
end


function scenario_damage_preprocess(job_file)
  inputs = Dict{ASCIIString, ScenarioDamageInput}()
  f = jldopen(job_file, "r")
  num_gmfs = read(f, "number_of_ground_motion_fields")
  hazard_model = f["hazard"]
  fragility_model = f["fragility"]
  exposure_model = f["exposure"]
  tax_ff_model = f["tax_ff_map"]

  assets = read_exposure(exposure_model)
  fragilities = read_fragility(fragility_model)
  tax_ff_map = read_tax_ff(tax_ff_model)

  branches = names(hazard_model)
  for branch in branches
    gmf_params = read_gmf_params(hazard_model[branch])
    gmfs = sample_gmfs(gmf_params..., num_gmfs)
    inputs[branch] = ScenarioDamageInput(assets, gmfs, tax_ff_map)
  end

  close(f)
  return inputs
end


function event_based_risk_preprocess(job_file)
  inputs = Dict{ASCIIString, EventBasedRiskInput}()
  f = jldopen(job_file, "r")
  time_h = read(f, "time_h")
  time_r = read(f, "time_r")
  num_ses = read(f, "num_ses")
  loss_curve_res = read(f, "loss_curve_res")
  insured_losses = read(f, "insured_losses")

  hazard_model = f["hazard"]
  vulnerability_model = f["vulnerability"]
  exposure_model = f["exposure"]
  tax_vf_model = f["tax_vf_map"]

  assets = read_exposure(exposure_model)
  vulnerabilities = read_vulnerability(vulnerability_model)
  tax_vf_map = read_tax_vf(tax_vf_model, vulnerabilities)

  branches = names(hazard_model)
  for branch in branches
    gmf_csv_file = read(hazard_model[branch]["gmf_csv"])
    gmfs = read_gmf_csv(gmf_csv_file)
    inputs[branch] = EventBasedRiskInput(assets, gmfs, tax_vf_map, time_h, time_r,
                                         num_ses, loss_curve_res, insured_losses)
  end

  close(f)
  return inputs
end


function classical_risk_preprocess(job_file)
  inputs = Dict{ASCIIString, ClassicalRiskInput}()
  f = jldopen(job_file, "r")
  time_h = read(f, "time_h")
  time_r = read(f, "time_r")
  lrem_steps = read(f, "lrem_steps")
  hazard_model = f["hazard"]
  vulnerability_model = f["vulnerability"]
  exposure_model = f["exposure"]
  tax_vf_model = f["tax_vf_map"]

  assets = read_exposure(exposure_model)
  vulnerabilities = read_vulnerability(vulnerability_model)
  tax_vf_map = read_tax_vf(tax_vf_model, vulnerabilities)

  branches = names(hazard_model)
  for branch in branches
    hc_params = read_hc_params(hazard_model[branch])
    hazard_curves = build_hazard_curves(hc_params..., time_h)
    inputs[branch] = ClassicalRiskInput(assets, hazard_curves, tax_vf_map, time_r, lrem_steps)
  end

  close(f)
  return inputs
end


function classical_damage_preprocess(job_file)
  inputs = Dict{ASCIIString, ClassicalDamageInput}()
  f = jldopen(job_file, "r")
  time_h = read(f, "time_h")
  time_r = read(f, "time_r")
  hazard_model = f["hazard"]
  fragility_model = f["fragility"]
  exposure_model = f["exposure"]
  tax_ff_model = f["tax_ff_map"]

  assets = read_exposure(exposure_model)
  fragilities = read_fragility(fragility_model)
  tax_ff_map = read_tax_ff(tax_ff_model, fragilities)

  branches = names(hazard_model)
  for branch in branches
    hc_params = read_hc_params(hazard_model[branch])
    hazard_curves = build_hazard_curves(hc_params..., time_h)
    inputs[branch] = ClassicalDamageInput(assets, hazard_curves, tax_ff_map, time_r)
  end

  close(f)
  return inputs
end


function read_exposure(exposure_model)
  asset_refs = names(exposure_model)
  assets = Set{Asset}()
  for a_ref in asset_refs
    a_loc = read(exposure_model[a_ref]["a_loc"])
    a_tax = read(exposure_model[a_ref]["a_tax"])
    a_num = read(exposure_model[a_ref]["a_num"])
    a_occ = read(exposure_model[a_ref]["a_occ"])
    a_val = read(exposure_model[a_ref]["a_val"])
    a_ded = read(exposure_model[a_ref]["a_ded"])
    a_lim = read(exposure_model[a_ref]["a_lim"])
    if isnan(a_ded)
      asset = Asset(a_ref, a_loc, a_tax, a_num, a_occ, a_val)
    else
      asset = Asset(a_ref, a_loc, a_tax, a_num, a_occ, a_val, a_ded, a_lim)
    end
    push!(assets, asset)
  end
  return assets
end


function read_fragility(fragility_model)
  ff_ids = names(fragility_model)
  fragilities = Dict{ASCIIString, FragilityFunction}()
  for ff_id in ff_ids
    ff_states = read(fragility_model[ff_id]["ff_states"])
    ff_type = read(fragility_model[ff_id]["ff_type"])
    if ff_type == "discrete"
      ff_imls = read(fragility_model[ff_id]["ff_imls"])
      ff_poes = read(fragility_model[ff_id]["ff_poes"])
      fragilities[ff_id] = DiscreteFragilityFunction(ff_states, ff_imls, ff_poes)
    else
      ff_mean_imls = read(fragility_model[ff_id]["ff_mean_imls"])
      ff_std_imls = read(fragility_model[ff_id]["ff_std_imls"])
      fragilities[ff_id] = ContinuousFragilityFunction(ff_states, ff_mean_imls, ff_std_imls)
    end
  end
  return fragilities
end


function read_vulnerability(vulnerability_model)
  vf_ids = names(vulnerability_model)
  vulnerabilities = Dict{ASCIIString, VulnerabilityFunction}()
  for vf_id in vf_ids
    vf_type = read(vulnerability_model[vf_id]["vf_type"])
    vf_imls = read(vulnerability_model[vf_id]["vf_imls"])
    if vf_type == "PM"
      vf_lrs = read(vulnerability_model[vf_id]["vf_lrs"])
      vf_probs = read(vulnerability_model[vf_id]["vf_probs"])
      vulnerabilities[vf_id] = DiscreteVulnerabilityFunction(vf_type, vf_imls, vf_lrs, vf_probs)
    else
      vf_mean_lrs = read(vulnerability_model[vf_id]["vf_mean_lrs"])
      vf_cov_lrs = read(vulnerability_model[vf_id]["vf_cov_lrs"])
      vulnerabilities[vf_id] = ContinuousVulnerabilityFunction(vf_type, vf_imls, vf_mean_lrs, vf_cov_lrs)
    end
  end
  return vulnerabilities
end


function read_tax_ff(tax_ff_model, fragilities)
  taxonomies = names(tax_ff_model)
  tax_ff_map = Dict{ASCIIString, Set{FragilityFunction}}()
  for tax in taxonomies
    tax_ff_map[tax] = Set{FragilityFunction}()
    for ff_id in read(tax_ff_model[tax])
      push!(tax_ff_map[tax], fragilities[ff_id])
    end
  end
  return tax_ff_map
end


function read_tax_vf(tax_vf_model, vulnerabilities)
  taxonomies = names(tax_vf_model)
  tax_vf_map = Dict{ASCIIString, Set{VulnerabilityFunction}}()
  for tax in taxonomies
    tax_vf_map[tax] = Set{VulnerabilityFunction}()
    for vf_id in read(tax_vf_model[tax])
      push!(tax_vf_map[tax], vulnerabilities[vf_id])
    end
  end
  return tax_vf_map
end


function read_gmf_params(gmf_params)
  gm_means = read(gmf_params["gm_means"])
  if exists(gmf_params, "corr_matrix")
    corr_matrix = read(gmf_params["corr_matrix"])
    gm_stds_intra = read(gmf_params["gm_stds_intra"])
    gm_stds_inter = read(gmf_params["gm_stds_inter"])
    return (gm_means, gm_stds_intra, gm_stds_inter, corr_matrix)
  else
    gm_stds = read(gmf_params["gm_stds"])
    return (gm_means, gm_stds)
  end
end


function read_gmf_csv(gmf_csv_file)
  gmvs = readcsv(gmf_csv_file, Float64)
  num_gmfs, num_locs = size(gmvs)
  gmfs = [GroundMotionField([loc => gmvs[i, loc] for loc=1:num_locs]) for i=1:num_gmfs]
  return gmfs
end

function read_hc_params(hc_params)
  hc_imls = read(hc_params["hc_imls"])
  hc_poes = read(hc_params["hc_poes"])
  return (hc_imls, hc_poes)
end


function build_hazard_curves(hc_imls, hc_poes, time_h)
  num_locs = size(hc_imls, 2)
  hazard_curves = [loc=>HazardCurve(time_h, hc_imls[:,loc], hc_poes[:,loc])
                   for loc in 1:num_locs]
  return hazard_curves
end
