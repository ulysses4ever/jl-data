module Multiclass

using Classifiers

import Classifiers.fit,Classifiers.predict,Classifiers.ClassifierConfig,Classifiers.Classifier

export MulticlassWithBinaryClassifier,OneVersusAllClassifier, OneVersusAllClassifierConfig,fit,predict

abstract  MulticlassWithBinaryClassifier <: Classifier

type OneVersusAllClassifier <:MulticlassWithBinaryClassifier
  binary_models::Vector{Classifier}
end


abstract  MulticlassWithBinaryClassifierConfig <: ClassifierConfig

type OneVersusAllClassifierConfig <:MulticlassWithBinaryClassifierConfig
    binary_classifier_config::ClassifierConfig
end


function fit(c::OneVersusAllClassifierConfig,x,y)
    classes=maximum(y)
    binary_models=Classifier[]

    for class=1:classes
      println("Training model for class $class")
      binary_y=copy(y)
      binary_y[y.==class]=1
      binary_y[y.!=class]=-1
      binary_model=fit(c.binary_classifier_config,x,binary_y)
      push!(binary_models,binary_model)
    end
    OneVersusAllClassifier(binary_models)
end
function predict(m::OneVersusAllClassifier,x)
    classes=length(m.binary_models)
    n=length(x)
    binary_models=Classifier[]
    results=zeros(n,classes)
    for class=1:classes
      binary_model=m.binary_models[class]
      results[:,class]=predict(binary_model,x)
    end
    predicted=zeros(n)
    for i=1:n
      detected=find(results[i,:].==1)
      if length(detected)==1
        predicted[i]=detected[1]
      end
    end
    predicted
end


end
