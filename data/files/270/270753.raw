#!/usr/bin/env julia
using Docker
using Convenience

const workspace = "workspace"
const machine = Machine("bempp-machine"; create=false, start=false)


create_or_use_directory(workspace)

const build_dir = joinpath(workspace, "build")
create_or_use_directory(build_dir)

activate!(machine) do machine
    const packaging = ["automake", "autoconf", "libtool", "pkg-config",
        "libcurl4-openssl-dev", "intltool", "libxml2-dev", "libgtk2.0-dev",
        "libnotify-dev", "libglib2.0-dev", "libevent-dev", "checkinstall",
        "dh-make", "cdbs", "apt-file"
    ]
    image(machine, "packaging", packaging; user="") |> run
end

macro add_package(name)
  quote
    include(string($name) * ".jl")
    activate!(machine) do machine
      eval($name).prepare()
      eval($name).make(machine) |> run
      eval($name).test(machine) |> run
    end
  end
end

@add_package :Cookoff
@add_package :TBB

