### Functions for expanding expressions that contain local variables

function fullexpand(exprn::Expr, vars::Array{Symbol, 1})
  dict = Dict{Symbol, Expr}(vars, fill(:(), length(vars)))

  for arg in exprn.args
    if arg.head == :(=)
      queue = Array(Union(Number, Symbol, Expr), 0)
      unshift!(queue, arg.args[2])
      
      while length(queue)!=0
        node = shift!(queue)
        
        if isa(node.args[2], Expr)
          unshift!(queue, node.args[2])
        elseif isa(node.args[2], Symbol)
          if get(dict, node.args[2], :()) != :()
            node.args[2] = dict[node.args[2]]
          end
        end
        
        if isa(node.args[3], Expr)
          unshift!(queue, node.args[3])
        elseif isa(node.args[3], Symbol)
          if get(dict, node.args[3], :()) != :()
            node.args[3] = dict[node.args[3]]
          end
        end
      end
      
      dict[arg.args[1]] = arg.args[2]
    elseif arg.head == :line
      continue
    else
      error("The given exprn can not be handled")
    end
  end
  
  exprn
end

function fullexpand(exprn::Expr)
  vars = Array(Symbol, 0)

  for arg in exprn.args
    if arg.head == :(=)
      unshift!(vars, arg.args[1])
    end
  end
  
  fullexpand(exprn, vars)
end
