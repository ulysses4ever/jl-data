include("Task_algo.jl")
include("util.jl")

n_x = 2048
nfreq = 120; 


waveletList = [WT.db1,WT.db2,WT.db3,WT.db4,WT.db5,WT.db6,WT.db7,WT.db8,WT.db9] ;
nWavelet = length(waveletList)

Nnodes = 3 ; 

node = Nodes(120) ; 
#create a canal connection of 10 Gbits/s
canal = Canal(10.0*1024) 



#acces the time to compute for each elementary operation :
nrep = 2
timeToCompute_B = mean([ ComputeTime_B(n_x) for i in [1:nrep]])
timeToCompute_X = mean( [ComputeTime_X(n_x) for i in [1:nrep]])
timeToCompute_Wavelet_compute =  [mean( [Wavelet_compute(n_x,wt ) for i in [1:nrep]]) for wt in waveletList ]
timeToCOmpute_update = mean([ update_multiplier(n_x) for i in [1:nrep]]) 
timeToCOmpute_Wavelet_sum = mean([ Wavelet_sum(n_x,nWavelet) for i in [1:nrep]]) 
timeToCompute_P =  mean([ ComputeTime_P(n_x) for i in [1:nrep]])  ;
timeToCompute_T  =  mean([ ComputeTime_T(n_x) for i in [1:nrep]]) ;
timeToCompute_Multiplier = mean([ update_multiplier(n_x) for i in [1:nrep]]) ;



listTask = {}
#X term 



	
Dependency_X = Dict() ;
X = Array(ASCIIString,1) ;resize!(X,nfreq) ;

for i_freq in 1:nfreq
	X = string("X_",i_freq) 
	Dependency_X = TaskDependancy([( string("B_",i_freq) ,0 )]) ;
	timeToCompute = timeToCompute_X
	temp =  Task_algo(X,Dependency_X,1,timeToCompute,node) 
	push!(listTask,temp)

	B = string("B_",i_freq) 
	Dependency_B = TaskDependancy([( string("Wavelet_sum_",i_freq) ,0 ),(string("Gamma_P_",i_freq),-1),(string("Gamma_S_",i_freq),-1)  ]) ;
	timeToCompute =timeToCompute_B
	temp =  Task_algo(B,Dependency_B,1,timeToCompute,node)
	push!(listTask,temp)
	
end

Dependency_Wavelet_sum= Dict() ;

for i_freq in 1:nfreq
	Wavelet_sum_str = string("Wavelet_sum_",i_freq)  ; 
	dependency_string=Array((ASCIIString,Int64),1) ; resize!(dependency_string,nWavelet) ;
	for i_wavelet in [1:nWavelet] 
		dependency_string[i_wavelet] =( string("Wavelet_compute_transpose_",i_wavelet,"_",i_freq),0 )  ; 
	end
	
	Dependency_Wavelet_sum = TaskDependancy(dependency_string) ;
	timeToCompute =timeToCOmpute_Wavelet_sum ;
	temp =  Task_algo(Wavelet_sum_str,Dependency_Wavelet_sum,1,timeToCompute,node) 
	push!(listTask,temp)	
end


for i_freq in 1:nfreq , i_wavelet in [1:nWavelet]

	Wavelet_compute_transpose=string("Wavelet_compute_transpose_",i_wavelet,"_",i_freq)  ; 
	Dependency_Wavelet_compute_transpose = TaskDependancy( [( string("Gamma_T_",i_wavelet,"_",i_freq),-1 ) ] );
	timeToCompute = timeToCompute_Wavelet_compute[i_wavelet]
	temp =  Task_algo(Wavelet_compute_transpose,Dependency_Wavelet_compute_transpose,1,timeToCompute,node) 
	push!(listTask,temp)
end



##on ajoute les taches 



#P term 



Dependency_P = Dict() ;
P = [string("P_",i_freq) for i_freq in [1:nfreq] ]
for i_freq in 1:nfreq
	P = string("P_",i_freq)  ; 
	Dependency_P[i_freq] = TaskDependancy( [( string("X_",i_freq) ,0 ),(string("Gamma_P_",i_freq),-1)  ] );
	timeToCompute = timeToCompute_P ;
	temp =  Task_algo(P,Dependency_P[i_freq],1,timeToCompute,node)  ;
	push!(listTask,temp) 	;
end

Dependency_Gamma_P = Dict() ;
for i_freq in 1:nfreq
	taskName = string("Gamma_P_",i_freq)
	Dependency_Gamma_P = TaskDependancy( [( string("X_",i_freq) ,0 ),(string("P_",i_freq),0)  ] ); 	
	timeToCompute = timeToCompute_Multiplier ;
	temp =  Task_algo(taskName,Dependency_Gamma_P,1,timeToCompute,node) 
	push!(listTask,temp) 
end






#S term 
for i_freq in 1:nfreq
	taskName = string("S_",i_freq) ;
	Dependency_S = TaskDependancy( [( string("X_",i_freq) ,0 ),(string("transfer_V"),0)  ] );
	temp =  Task_algo(taskName,Dependency_S,1,1.0,node) 
	push!(listTask,temp) 

	taskName = string("Gamma_S_",i_freq) ;
	Dependency_Gamma_S_ = TaskDependancy( [( string("S_",i_freq) ,0 ) ] );
	temp =  Task_algo(taskName,Dependency_S,1,timeToCompute_Multiplier,node) 
	push!(listTask,temp) 


	transfer_S  =  string("transfer_S_",i_freq) ;
	Dependency_transfer_S_ = TaskDependancy( [( string("S_",i_freq) ,0 ) ] );
	temp =  DataTransfer(transfer_S,Dependency_transfer_S_,1,n_x*n_x*64.0/(1024*1024),canal) ; 
	push!(listTask,temp) 
end



#V term 


taskName = "transfer_V" ;
dependency_string=Array((ASCIIString,Int64),1) ; resize!(dependency_string,nfreq) ;
for i_freq in 1:nfreq
	dependency_string[i_freq] = ( string("X_",i_freq) ,0) ; 
end
Dependency_transfer_V=TaskDependancy(dependency_string);
temp =  DataTransfer(taskName,Dependency_transfer_V,1,nfreq*32.0,canal) ; 
push!(listTask,temp) ;


#T term 

for i_wavelet in [1:nWavelet] , i_freq in [1:nfreq]

	Gamma_T =  string("Gamma_T_",i_wavelet,"_",i_freq)  ;
	Dependency_Gamma_T = TaskDependancy( [(string("T_",i_wavelet,"_",i_freq) ,0 ) ] );
	temp =  Task_algo(Gamma_T,Dependency_Gamma_T,1,timeToCompute_Multiplier,node)  ;  
	push!(listTask,temp) 

	T = string("T_",i_wavelet,"_",i_freq)   ; 
	Dependency_T  = TaskDependancy( [ (string("Wavelet_compute_",i_wavelet,"_",i_freq),0 ) ] );
	temp =  Task_algo(T,Dependency_T,1,timeToCompute_T,node)  ;  
	push!(listTask,temp)

	Wavelet_compute_str=string("Wavelet_compute_",i_wavelet,"_",i_freq)  ; 
	Dependency_Wavelet_compute  = TaskDependancy( [ ( string("X_",i_freq) ,0 ) ] );
	temp =  Task_algo(Wavelet_compute_str,Dependency_Wavelet_compute,1,timeToCompute_Wavelet_compute[i_wavelet],node)  ;  
	push!(listTask,temp)

end










etat = State() ;
for a in  listTask
	i = a.taskName ; 
    etat.states[i] = DictChannel() 
    put!(etat.states[i],0,true) ; 
end


for i in  1:nfreq
 
    #put!(etat.states[string("X_",i)],1,true) ; 
end


N_max= 30
for t in listTask
	@async begin 
		eventloop(t,etat,N_max)
	end 
end






for a in  listTask
	i = a.taskName ; 
    println(i)
end