using Knet, Base.Test
isapprox3(a,b;o...)=all(map((x,y)->(x==y || isapprox(x,y;o...)), a,b))
load_only = true

include("linreg.jl")
#@time @show test1 = linreg()
# 7.640272 seconds (8.43 M allocations: 434.688 MB, 1.68% gc time)
@time @show test1 = linreg()
# 0.937878 seconds (663.84 k allocations: 84.173 MB, 3.46% gc time)
@test test1  == (0.0005497372347062405,32.77256166946498,0.11244349406523031)

include("mnist2d.jl")
#@time @show test2 = mnist2d()
# 10.326349 seconds (8.53 M allocations: 391.387 MB, 1.52% gc time)
@time @show test2 = mnist2d()
# 6.504692 seconds (4.37 M allocations: 198.486 MB, 0.88% gc time)
@test test2  == (0.10628127f0,24.865438f0,3.5134742f0)

#@time @show test3 = mnist2d("--ysparse")
# 8.948592 seconds (5.47 M allocations: 261.566 MB, 0.86% gc time)
@time @show test3 = mnist2d("--ysparse")
# 7.720386 seconds (4.41 M allocations: 214.496 MB, 0.81% gc time)
@test test3  == (0.1062698f0,24.866688f0,3.513474f0)

#@time @show test4 = mnist2d("--xsparse")
# 13.094550 seconds (5.84 M allocations: 860.164 MB, 1.36% gc time)
@time @show test4 = mnist2d("--xsparse")
# 12.134260 seconds (4.92 M allocations: 815.665 MB, 1.33% gc time)
@test isapprox(test4[1], 0.10628127f0; rtol=0.005)
@test isapprox(test4[2], 24.865437f0; rtol=0.002)
@test isapprox(test4[3], 3.5134742f0; rtol=0.02)

#@time @show test5 = mnist2d("--xsparse --ysparse")
# 13.590826 seconds (5.14 M allocations: 839.147 MB, 1.24% gc time)
@time @show test5 = mnist2d("--xsparse --ysparse")
# 13.390442 seconds (5.01 M allocations: 832.642 MB, 1.24% gc time)
@test isapprox(test5[1], 0.10628127f0; rtol=0.005)
@test isapprox(test5[2], 24.865437f0; rtol=0.002)
@test isapprox(test5[3], 3.5134742f0; rtol=0.02)

include("mnist4d.jl")
#@time @show test6 = mnist4d()
# 19.446981 seconds (12.69 M allocations: 607.090 MB, 0.94% gc time)
@time @show test6 = mnist4d()
# 17.030179 seconds (10.00 M allocations: 487.578 MB, 0.91% gc time)
@test isapprox(test6[1], 0.050180204f0; rtol=.01)
@test isapprox(test6[2], 25.783848f0;   rtol=.01)
@test isapprox(test6[3], 9.420588f0;    rtol=.1)

include("mnistpixels.jl")
#@time @show test7 = mnistpixels()
# 11.562187 seconds (45.23 M allocations: 1.189 GB, 2.66% gc time)
@time @show test7 = mnistpixels()
# 9.398664 seconds (43.09 M allocations: 1.090 GB, 3.22% gc time)
@test test7  == (0.1216,2.3023171f0,10.4108f0,30.598776f0)

include("adding.jl")
#@time @show test8 = adding()
# 11.399485 seconds (18.10 M allocations: 836.271 MB, 3.45% gc time)
@time @show test8 = adding()
# 10.262474 seconds (16.87 M allocations: 779.129 MB, 2.80% gc time)
@test test8  == (0.04885713f0, 5.6036315f0,3.805253f0)

include("rnnlm.jl")
#@time @show test9 = rnnlm("ptb.valid.txt ptb.test.txt")
# 32.368835 seconds (22.35 M allocations: 2.210 GB, 1.56% gc time)
@time @show test9 = rnnlm("ptb.valid.txt ptb.test.txt")
# 29.791355 seconds (19.68 M allocations: 2.093 GB, 1.57% gc time)
@test isapprox3(test9, (814.9780887272417,541.2457922913605,267.626257438979,120.16170771885587); rtol=.02)
