using Glmnet, Base.Test

X = [74    1  93  93  79  18
     98   36   2  27  65  70
     61    8  99  53  77  92
     47   51  67  84  87  80
     81   32   9  18  32  10
     78   67  92  98   4  65
     67   94  30  20  85  73
     51  100  75  76  86  18
     93   71  76  64  70  91
     30    5  13  89  19  2]
y = [9, 67, 91, 80, 2, 61, 70, 13, 83, 21]
path = fit(X, y)

# From R glmnet
df = [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,4,4,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6]
dev_ratio = [0,0.1611406847,0.2949225122,0.4059905356,0.4982011599,0.5747560401,0.6383132466,0.6910795561,0.7348870732,0.7712568435,0.8014516657,0.8265199376,0.8473320574,0.8646106448,0.8789556317,0.8908650918,0.9007525347,0.9089612636,0.9157762946,0.921434253,0.9261315894,0.9300314007,0.9332690925,0.9359570811,0.9398657226,0.945705192,0.9505511735,0.954574392,0.9579145386,0.9606875869,0.9629898204,0.9663259092,0.9704791586,0.9740634616,0.9773275819,0.9800320948,0.9822774198,0.9841415281,0.9856891436,0.9869684203,0.988036043,0.988922438,0.9898389202,0.9907513046,0.9915176738,0.9921544907,0.9926832231,0.9931161877,0.9934811105,0.993784561,0.9940365343,0.9942415128,0.9944153885,0.9945601976,0.9946804775,0.9947772389,0.9948601574,0.9949294264,0.9949870099,0.9950348299,0.9950724417,0.9951053024,0.9951329295,0.9951559502,0.9951750831,0.9951909727,0.9952041658,0.9952151193,0.9952242131]
λ = [31.8289169496,29.0013236919,26.4249260262,24.0774084281,21.9384378235,19.9894874721,18.2136764984,16.5956236773,15.1213142093,13.777978331,12.5539807098,11.4387196638,10.4225353353,9.4966260218,8.6529719398,7.8842657613,7.183849321,6.5456559468,5.9641579131,5.434318562,4.9515486786,4.511666741,4.1108627024,3.7456649899,3.4129104357,3.109716879,2.8334582022,2.5817415848,2.352386778,2.1434072201,1.9529928302,1.7794943298,1.621408958,1.477367455,1.3461222021,1.2265364157,1.117574301,1.0182920803,0.9278298184,0.8454039745,0.7703006155,0.7018692318,0.6395171037,0.5827041668,0.5309383346,0.4837712363,0.440794333,0.4016353793,0.3659551992,0.3334447479,0.3038224355,0.2768316877,0.2522387236,0.2298305306,0.2094130197,0.1908093442,0.1738583679,0.1584132697,0.1443402714,0.1315174795,0.1198338291,0.109188122,0.0994881502,0.0906498971,0.0825968101,0.0752591371,0.0685733228,0.0624814578,0.0569307773]
a0 = [49.7, 45.3564158503177, 41.3987037450736, 37.7925838753477, 34.5068217559655, 31.5129576873293, 28.7850602511156, 26.2995017047348, 24.034753329128, 21.971198957302, 20.090965068475, 18.3777659761895, 16.8167627694882, 15.394434785365, 14.0984624992512, 12.9176208191865, 11.8416818594426, 10.8613263514704, 9.96806292485341, 9.15415455911991, 8.41255156937272, 7.73683054529119, 7.12113871462388, 6.56014324927526, 6.58063782500258, 7.46077449978637, 8.2619969650005, 8.99204080542006, 9.65722956306944, 10.2633247848263, 10.8155761775506, 11.752323523965, 13.1190988923835, 14.3906024051726, 15.6144444818097, 16.7269990088934, 17.7407121192727, 18.6643697413071, 19.5059721658893, 20.2682389137493, 20.9673256125271, 21.604339554904, 21.8013580787941, 21.6435121171738, 21.4854892971093, 21.3405100552143, 21.20834094952, 21.1018083210422, 20.9922078184326, 20.8911096494637, 20.7988719397475, 20.7285942864877, 20.652704588566, 20.5818972051069, 20.5171522427852, 20.4717556882645, 20.4195164444671, 20.3696925422545, 20.3238654536683, 20.282026786402, 20.25582230825, 20.2237130253272, 20.1917640015501, 20.1619151307503, 20.134518070829, 20.109500814449, 20.0866913936042, 20.0659043415446, 20.0469628833773]

@test path.betas.df == df
@test_approx_eq path.dev_ratio dev_ratio
@test_approx_eq path.λ λ
@test_approx_eq path.a0 a0

# Only check 3 random models; if these are right the rest should be too
models = [11, 46, 54]
betas = [0.0000000000000000 -0.26106259863474601 -0.26999306570454373
         0.0000000000000000 -0.03329369198952250 -0.04052553140335470
         0.0000000000000000 -0.08096633358970667 -0.11301841848092280
         0.0000000000000000  0.02497015329885828  0.05893642256095720
         0.0000000000000000 -0.05815325804765525 -0.05965937657889149
         0.5705016364455693  1.04279276932443676  1.07097251257554626]
@test_approx_eq path.betas[:, models] betas

# Test consistency of indexing into compressed array
betas = path.betas
cbetas = convert(Matrix, path.betas)
for j = 1:size(betas, 2), i = 1:size(betas, 1)
    @assert betas[i, j] == cbetas[i, j]
    @assert betas[1:i, j] == cbetas[1:i, j]
    @assert betas[i:end, j] == cbetas[i:end, j]
    @assert betas[i, 1:j] == cbetas[i, 1:j]
    @assert betas[i, j:end] == cbetas[i, j:end]
    @assert betas[1:i, 1:j] == cbetas[1:i, 1:j]
    @assert betas[i:end, j:end] == cbetas[i:end, j:end]
end
