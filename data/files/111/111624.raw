# -*- coding: utf-8 -*-

#=
Created on Mon Nov 09 2015 11:56:22
@author: William Herrera
Julia 0.4 code to analyze sound and use as interface with ASUS G20 lighting
Tk widgets GUI version
IMPORTANT: run as administrator
=#

using Tk
include("SoundLighting.jl")

type GUIInputParameters 
    dll_path::AbstractString
    chunk_exponent::Integer
    worker::Any
    worker_running::Bool
    rotation_interval::Integer
    device_number::Integer
    device_dict::Any
    device_radio_button::Any
    chunk_size_slider::Any
    rotation_slider::Any
end

# default global parameters
 paramTk = GUIInputParameters(LIGHTS.DLLPath, CHUNK_EXPONENT, Void, 
                              false, LIGHT_ROTATION_INTERVAL,
                              DEVICE_NUMBER, Void, Void, Void, Void)

"""
Choose path to dll
"""
function pick_dll_path(path)
    path_chosen = ChooseDirectory(root,"Path to ACPIWMI.dll",
                                  initialdir=paramTk.dll_path)
    if isfile(string(path_chosen, '/', LightACPI.DLLNAME))
        paramTk.dll_path = path_chosen
    else
        Messagebox(Void, path_chosen,
                             "ACPIWMI.dll not found in this path")
    end
    paramTk.dll_path
end

"""
End execution of app
"""
function quit_app(path)
    global CONTINUE
    iexcept = InterruptException()
    if paramTk.worker_running
        Base.throwto(paramTk.worker, iexcept)
    end
    CONTINUE = false
end

"""
Begin sampling display thread
"""
function audio_to_lighting(path)
    # get and set the audio port number
    dev_text = get_value(paramTk.device_radio_button)
    DEVICE_NUMBER = paramTk.device_dict[dev_text]
    
    # get and set the dll path directory and initialize lighting
    new_dpath = paramTk.dll_path
    if new_dpath != LIGHTS.DLLPath
        ENV["PATH"] = string(new_dpath, ";", ENV["PATH"])
        LightACPI.initialize!()
    end

    # get and set the exponent for the chunk size
    paramTk.chunk_exponent = Integer(get_value(paramTk.chunk_size_slider))
    CHUNK_EXPONENT = paramTk.chunk_exponent

    # get and set the exponent for the rotation interval
    paramTk.rotation_interval = Integer(get_value(paramTk.rotation_slider))
    LIGHT_ROTATION_INTERVAL = paramTk.rotation_interval

    # restart task with the new parameters
    restart_task(paramTk)
end

"""
Start and set up app and its widgets.
"""
function SetupApp(WINDW, param=paramTk)
    # Set SoundLighting globals.
    param.dll_path = LightACPI.LIGHTS.DLLPath
    param.chunk_exponent = CHUNK_EXPONENT
    param.rotation_interval = LIGHT_ROTATION_INTERVAL
    param.device_number = DEVICE_NUMBER

    root = Frame(WINDW)
    pack(root)
    pack(Label(root, "ASUS ROG Desktop Audio Lighting Control"))
    pack(Separator(root, orient="horizontal"))

    # Choose device for input
    pack(Label(root, "Audio Device Choices"))
    dev_num, dev_name = list_devices(false)
    param.device_dict = [ dev_name[idx] => dev_num[idx] 
                          for idx in 1:length(dev_name) ]
    default_rb = 1
    for idx in 1:length(dev_name)
        txt = dev_name[idx]
        if contains(txt, "Mix") & (default_rb == 1)
            default_rb = idx
        end
    end
    param.device_radio_button = Radio(root, dev_name, "vertical")
    set_value(param.device_radio_button, default_rb)
    pack(param.device_radio_button)
    pack(Separator(root, orient="horizontal"))

    # Choose alternative path to dll (optional)
    dllpath = param.dll_path
    dllpath = replace(dllpath, r"\\", "/")
    pack(Label(root, string("Default Path to ACPIWMI.dll is $dllpath")))
    directory_choice_button = Button(root, "Change Path to ACPIWMI.dll")
    bind(directory_choice_button, "command", pick_dll_path)
    pack(Separator(root, orient="horizontal"))

    # choose the lighting color update interval
    pack(Label(root, "Doubling increment for Update Interval"))
    param.chunk_size_slider = Slider(root, 12:18, orient="horizontal")
    set_value(param.chunk_size_slider, CHUNK_EXPONENT)
    pack(param.chunk_size_slider)
    pack(Separator(root, orient="horizontal"))
    
    # rotation button
    pack(Label(root, "Rotation Interval (0 for Off)"))
    param.rotation_slider = Slider(root, 0:25, orient="horizontal")
    set_value(param.rotation_slider, LIGHT_ROTATION_INTERVAL)
    pack(param.rotation_slider)
    pack(Separator(root, orient="horizontal"))

    # start app button
    start_button = Button(root, "Start")
    bind(start_button, "command", audio_to_lighting)
    pack(start_button)

    # quit app button
    quit_button = Button(root, "QUIT")
    bind(quit_button, "command", quit_app)
    pack(quit_button)
end

"""
Restart worker thread (needed if parameters update)
"""
function restart_task(param=paramTk)
    iexcept = InterruptException()
    if param.worker_running
        Base.throwto(param.worker, iexcept)
        sleep(0.1)
    end
    param.worker = @async(asus_soundlight(false))
end



# Start program.
WIN = Toplevel()
APP = SetupApp(WIN)
CONTINUE = true

while CONTINUE
    yield()
end
